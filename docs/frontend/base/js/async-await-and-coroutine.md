---
title: 'åç¨‹ä¸æ‰‹å†™async/await'
date: '2020-9-5'
---

## åç¨‹(coroutine)

å·²çŸ¥`async/await`å°±æ˜¯`ç”Ÿæˆå™¨(Generator)`çš„è¯­æ³•ç³–ï¼Œè€Œåè€…çš„å®ç°ï¼Œåˆ™æ˜¯å¼‚æ­¥ç¼–ç¨‹ä¸­çš„`åç¨‹`æ¨¡å¼ã€‚æŒ‡è·¯ğŸ‘‰[é˜®ä¸€å³°ï¼šGeneratorå‡½æ•°çš„å¼‚æ­¥åº”ç”¨](https://es6.ruanyifeng.com/#docs/generator-async)ã€‚

- åç¨‹æ˜¯ä»€ä¹ˆï¼Ÿä»¥è¯¥ä»£ç ä¸ºä¾‹

  ```js
  function* genDemo() {
      console.log("å¼€å§‹æ‰§è¡Œç¬¬ä¸€æ®µ")
      yield 'generator 1'
      console.log("æ‰§è¡Œç»“æŸ")
      return 'generator 2'
  }
  console.log('main 0')
  let gen = genDemo()
  console.log(gen.next().value)
  console.log('main 1')
  console.log(gen.next().value)
  console.log('main 2')
  // main 0
  // å¼€å§‹æ‰§è¡Œç¬¬ä¸€æ®µ
  // generator 1
  // main 1
  // æ‰§è¡Œç»“æŸ
  // generator 2
  // main 2
  ```

  ![åç¨‹demoç¤ºæ„å›¾](../../../.imgs/js-coroutine-demo-with-call-stack.png)

  1. é€šè¿‡è°ƒç”¨ç”Ÿæˆå™¨å‡½æ•°genDemoæ¥åˆ›å»ºä¸€ä¸ªåç¨‹genï¼Œåˆ›å»ºä¹‹åï¼Œgenåç¨‹å¹¶æ²¡æœ‰ç«‹å³æ‰§è¡Œã€‚
  2. è¦è®©genåç¨‹æ‰§è¡Œï¼Œéœ€è¦é€šè¿‡è°ƒç”¨gen.nextã€‚
  3. å½“genåç¨‹æ­£åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡yieldå…³é”®å­—æ¥æš‚åœgenåç¨‹çš„æ‰§è¡Œï¼Œå¹¶è¿”å›ä¸»è¦ä¿¡æ¯ç»™çˆ¶åç¨‹ã€‚
  4. å¦‚æœåç¨‹åœ¨æ‰§è¡ŒæœŸé—´ï¼Œé‡åˆ°äº†returnå…³é”®å­—ï¼Œé‚£ä¹ˆä¼šç»“æŸå½“å‰åç¨‹ï¼Œå¹¶å°†returnåé¢çš„å†…å®¹è¿”å›ç»™çˆ¶åç¨‹ã€‚

- ç”±äºReactæºç ä¸­çš„`Fiber(çº¤ç¨‹)`æ¦‚å¿µã€‚å‚è€ƒäº†çŸ¥ä¹çš„ä¸€ç¯‡æ–‡ç« [åç¨‹å’Œçº¤ç¨‹çš„åŒºåˆ«ï¼Ÿ](https://www.zhihu.com/question/23955356)ï¼Œæˆ–è®¤ä¸ºå·®åˆ«æ˜¯æ¯ä¸ª`Fiber(çº¤ç¨‹)`æ‹¥æœ‰è‡ªå·±çš„å®Œæ•´stackï¼Œè€Œåç¨‹æ˜¯å…±ç”¨çº¿ç¨‹çš„stackã€‚
- é‚£ä¹ˆï¼Œåç¨‹å…±ç”¨çº¿ç¨‹çš„è°ƒç”¨æ ˆåº”è¯¥æ€ä¹ˆç†è§£å‘¢ï¼Ÿ
  - å½“åœ¨genåç¨‹ä¸­è°ƒç”¨äº†yieldæ–¹æ³•æ—¶ï¼ŒJSå¼•æ“ä¼šä¿å­˜genåç¨‹å½“å‰çš„è°ƒç”¨æ ˆä¿¡æ¯ï¼Œå¹¶æ¢å¤çˆ¶åç¨‹çš„è°ƒç”¨æ ˆä¿¡æ¯ã€‚
  - åŒæ ·ï¼Œå½“åœ¨çˆ¶åç¨‹ä¸­æ‰§è¡Œgen.nextæ—¶ï¼ŒJSå¼•æ“ä¼šä¿å­˜çˆ¶åç¨‹çš„è°ƒç”¨æ ˆä¿¡æ¯ï¼Œå¹¶æ¢å¤genåç¨‹çš„è°ƒç”¨æ ˆä¿¡æ¯ã€‚
